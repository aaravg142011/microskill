<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MicroSkill Snap</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      background-color: #1A1A1A;
      color: #FFFFFF;
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      padding: 0 16px;
    }
    @media (min-width: 768px) {
      html, body { max-width: 600px; margin: 0 auto; }
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }
    h1 { color: #FF4D4D; font-size: 2rem; margin-bottom: 24px; }
    .challenge-card {
      background: #333333;
      border: 1px solid #FF4D4D;
      border-radius: 8px;
      padding: 24px;
      margin: 16px 0;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      animation: slideIn 0.3s ease-out;
    }
    textarea {
      width: 100%;
      max-width: 500px;
      min-height: 100px;
      padding: 8px;
      background: #FFFFFF;
      color: #1A1A1A;
      border: 1px solid #333333;
      border-radius: 6px;
      font-size: 1rem;
      resize: vertical;
    }
    textarea:focus { outline: none; border-color: #FF4D4D; }
    button {
      background: #FF4D4D;
      color: #FFFFFF;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      margin: 8px;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) { background: #FF6666; }
    button:disabled { background: #666; cursor: not-allowed; }
    .feedback {
      background: #1A1A1A;
      border: 1px solid #FF4D4D;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      max-width: 500px;
      width: 100%;
      white-space: pre-wrap;
      animation: slideIn 0.5s ease-out;
    }
    .loading { color: #FF4D4D; font-style: italic; }
    .error {
      color: #FF4D4D;
      background: #333;
      padding: 10px;
      border-radius: 4px;
    }
    @keyframes slideIn {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ MicroSkill Snap</h1>
    <div class="challenge-card" id="challenge">Loading AI... <span class="loading">‚è≥</span></div>
    <textarea id="answer" placeholder="Your 5-min response..."></textarea>
    <button id="newBtn">New Challenge</button>
    <button id="submitBtn">Submit & Get Feedback</button>
    <div class="feedback" id="feedback" style="display:none;"></div>
    <div class="error" id="error" style="display:none;"></div>
  </div>

  <script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js';

    let generator = null;
    let aiLoaded = false;
    let useAI = true;
    let challengesDone = 0;
    let currentChallenge = '';

    const fallbackPrompts = [
      "Write a 40-word story about a time traveler in a bakery.",
      "List 3 creative uses for a paperclip.",
      "If you could add one rule to your school, what would it be?",
      "Explain why cats would make good astronauts in 3 sentences.",
      "Invent a new sport using only socks and chairs."
    ];
    let usedPrompts = [];

    function getUniquePrompt() {
      if (usedPrompts.length === fallbackPrompts.length) {
        usedPrompts = [];
      }
      let available = fallbackPrompts.filter(p => !usedPrompts.includes(p));
      let chosen = available[Math.floor(Math.random() * available.length)];
      usedPrompts.push(chosen);
      return chosen;
    }

    async function loadModel() {
      try {
        console.log("Loading AI model...");
        generator = await pipeline('text-generation', 'Xenova/gpt2');
        aiLoaded = true;
        console.log("AI loaded!");
        getChallenge();
      } catch (err) {
        console.error("AI load failed:", err);
        useAI = false;
        getChallenge();
      }
    }

    async function getChallenge() {
      const challengeDiv = document.getElementById('challenge');
      challengeDiv.textContent = "Generating challenge...";
      try {
        if (useAI && aiLoaded && generator) {
          const basePrompt = getUniquePrompt();
          const fullPrompt = `Create a fun, unique, 5-minute skill challenge based on this idea: "${basePrompt}". Keep it under 80 words.`;
          const result = await generator(fullPrompt, { max_new_tokens: 60, temperature: 0.8 });
          currentChallenge = result[0].generated_text.replace(fullPrompt, '').trim();
          if (!currentChallenge || currentChallenge.length < 10) {
            currentChallenge = basePrompt;
          }
        } else {
          currentChallenge = getUniquePrompt();
        }
        challengeDiv.textContent = currentChallenge;
        document.getElementById('answer').value = '';
        document.getElementById('feedback').style.display = 'none';
        challengesDone++;
      } catch (e) {
        console.error("Challenge error:", e);
        currentChallenge = getUniquePrompt();
        challengeDiv.textContent = currentChallenge;
      }
    }

    async function submitAnswer() {
      const answer = document.getElementById('answer').value.trim();
      if (!answer) {
        alert("Please enter an answer first!");
        return;
      }
      const feedbackDiv = document.getElementById('feedback');
      feedbackDiv.style.display = 'block';
      feedbackDiv.textContent = "Crafting feedback...";

      try {
        if (useAI && aiLoaded && generator) {
          const fbPrompt = `You are a hype coach. Give feedback on this answer: "${answer}" for the challenge: "${currentChallenge}". 
          Start with emoji encouragement, add 1-2 specific tips, end with a fun badge and streak number ${challengesDone}. Keep it under 70 words.`;
          const result = await generator(fbPrompt, { max_new_tokens: 80, temperature: 0.9 });
          let feedback = result[0].generated_text.replace(fbPrompt, '').trim();
          if (!feedback || feedback.length < 10) {
            feedback = `Great try! üí™ Tip: Expand your detail. Badge: Creative Spark üèÜ Streak: ${challengesDone}`;
          }
          feedbackDiv.textContent = feedback;
        } else {
          feedbackDiv.textContent = `Nice effort! üåü Tip: Add more detail. Badge: Skill Starter üèÜ Streak: ${challengesDone}`;
        }
      } catch (e) {
        console.error("Feedback error:", e);
        feedbackDiv.textContent = `Good effort! ‚ú® Badge: Beginner Boost üèÜ Streak: ${challengesDone}`;
      }
    }

    document.getElementById('newBtn').addEventListener('click', getChallenge);
    document.getElementById('submitBtn').addEventListener('click', submitAnswer);

    window.addEventListener('load', loadModel);
  </script>
</body>
</html>
